image: $CI_REGISTRY/abgabesystem/docker-abgabesystem:latest

variables:
  BASECODE: solutions/solutions
  CI_REPO_HOST: $CI_REGISTRY

stages:
  - test
  - sync
  - deadlines
  - plagiates

before_script:
  ## get ssh private key from secret variable
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-add -l
  - ssh-keyscan $CI_REPO_HOST | tee ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts
  ## get API token from secret variable
  - cp python-gitlab.cfg $HOME/.python-gitlab.cfg
  - echo "private_token = ${PRIVATE_API_TOKEN}" >> $HOME/.python-gitlab.cfg

deadlines:
  stage: deadlines
  tags:
    - abgabesystem

  script:
    - python3 ./abgabesystem.py deadline -t test -r test_course/solutions/solutions

  only:
    - tags

plagiates:
  stage: plagiates
  tags:
    - abgabesystem

  script:
    - mkdir -p results
    - python3 ./abgabesystem.py plagiates -t test -r test_course/solutions/solutions -j /app/jplag.jar

  artifacts:
    paths:
    - results/

  only:
    - tags

doc:
  stage: test
  tags:
    - abgabesystem

  script:
    - make html

  artifacts:
    paths:
    - _build/html/
