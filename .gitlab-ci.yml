image: $CI_REGISTRY/abgabesystem/docker-abgabesystem:latest

variables:
  BASECODE: test_solutions
  CI_REPO_HOST: ips1.ibr.cs.tu-bs.de

stages:
  - test
  - sync
  - deadlines
  - plagiates

before_script:
  ## get ssh private key from secret variable
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-add -l
  - ssh-keyscan $CI_REPO_HOST | tee ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts
  ## get API token from secret variable
  - cp python-gitlab.cfg $HOME/.python-gitlab.cfg
  - echo "private_token = ${PRIVATE_API_TOKEN}" >> $HOME/.python-gitlab.cfg

deadlines:
  stage: deadlines
  tags:
    - abgabesystem

  script:
    - python3 abgabesystem.py deadline $CI_COMMIT_REF_NAME

  only:
    - tags

plagiates:
  stage: plagiates
  tags:
    - abgabesystem

  script:
    - mkdir -p results
    - python3 abgabesystem.py plagiates $CI_COMMIT_REF_NAME

  artifacts:
    paths:
    - results/

  only:
    - tags

sync:
  stage: sync
  tags:
    - abgabesystem

  script:
    - python3 abgabesystem.py sync

  only:
    - master

  except:
    - tags

doc:
  stage: test
  tags:
    - abgabesystem

  script:
    - make html

  artifacts:
    paths:
    - _build/html/
